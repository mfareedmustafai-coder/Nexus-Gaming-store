<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Gaming Store</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --bg-dark: #0f1014;
            --bg-card: #1b1e26;
            --primary: #00d4ff; 
            --text-main: #ffffff;
            --text-muted: #a1a1a6;
            --gradient: linear-gradient(45deg, #00d4ff, #0051ff);
            --danger: #ff4757;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-main); overflow-x: hidden;}
        a { text-decoration: none; color: inherit; }

        /* --- NAVBAR --- */
        nav { 
            position: fixed; top: 0; width: 100%; padding: 15px 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(15, 16, 20, 0.98); border-bottom: 1px solid #333; 
            z-index: 1000; 
        }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: 1px; display:flex; align-items:center; gap:10px;}
        
        .nav-right { display: flex; align-items: center; gap: 20px; }

        .search-bar { position: relative; }
        .search-bar input { background: #252830; border: 1px solid #333; padding: 8px 15px 8px 35px; border-radius: 20px; color: white; width: 200px; transition: 0.3s; }
        .search-bar input:focus { width: 250px; border-color: var(--primary); }
        .search-bar i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; font-size: 14px; }

        /* AUTH BUTTONS */
        .btn-login { border: 1px solid var(--primary); color: var(--primary); padding: 6px 15px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.3s; background: transparent; font-size: 14px; }
        .btn-login:hover { background: var(--primary); color: black; }
        
        .user-profile-icon { 
            width: 35px; height: 35px; border-radius: 50%; 
            background: var(--gradient); display: flex; align-items: center; justify-content: center; 
            font-weight: bold; cursor: pointer; display: none; overflow: hidden;
            border: 2px solid #333;
        }
        .user-profile-icon img { width: 100%; height: 100%; object-fit: cover; }

        /* --- LAYOUT --- */
        .app-layout { display: flex; margin-top: 70px; min-height: 100vh; }
        
        .sidebar { 
            width: 240px; position: fixed; left: 0; top: 70px; bottom: 0; 
            background: var(--bg-dark); padding: 20px; border-right: 1px solid #222;
            display: flex; flex-direction: column; gap: 5px; z-index: 900;
        }
        .menu-item { padding: 12px 15px; border-radius: 8px; color: #aaa; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px; font-size: 15px; }
        .menu-item:hover, .menu-item.active { background: #1f222a; color: white; }
        .menu-item i { width: 20px; text-align: center; }

        .main-content { margin-left: 240px; flex: 1; padding: 20px; }

        /* --- HERO --- */
        .hero-banner {
            border-radius: 15px; height: 280px; display: flex; align-items: center; padding: 40px;
            background: linear-gradient(to right, rgba(0,0,0,0.9), transparent), url('https://images.unsplash.com/photo-1542751371-adc38448a05e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center; margin-bottom: 30px;
        }
        .hero-text h1 { font-size: 2.8rem; margin: 0; text-shadow: 0 5px 20px rgba(0,0,0,0.8); line-height: 1.1; }
        
        /* --- GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card { background-color: var(--bg-card); border-radius: 12px; overflow: hidden; cursor: pointer; border: 1px solid #333; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card-img-wrapper { width: 100%; height: 180px; position: relative; background: #202020; overflow: hidden; }
        .card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .card:hover img { transform: scale(1.1); }
        
        .wishlist-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; transition: 0.2s; }
        .wishlist-btn:hover, .wishlist-btn.active { background: white; color: var(--danger); }

        .card-content { padding: 12px; }
        .card h3 { margin: 0; font-size: 15px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-stats { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 5px; }
        .verified-badge { color: var(--primary); font-size: 10px; font-weight: bold; text-transform: uppercase; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        
        /* Auth Box */
        .auth-box { background: #1b1e26; padding: 30px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid #333; position: relative; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #0f1014; border: 1px solid #333; color: white; border-radius: 6px; }
        .auth-btn { width: 100%; padding: 12px; background: var(--gradient); border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; border: none; font-size: 20px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; z-index: 100; }

        /* --- GAME DETAIL --- */
        .modal-content { background: #15171e; width: 95%; max-width: 900px; max-height: 95vh; border-radius: 16px; overflow-y: auto; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .modal-header-img { width: 100%; height: 350px; object-fit: contain; background: #000; }
        .modal-body { padding: 30px; margin-top: -80px; position: relative; }
        .game-head-row { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 25px; }
        .game-logo-large { width: 120px; height: 120px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #000; object-fit: cover; border: 3px solid #15171e; }
        
        .stats-bar { display: flex; gap: 30px; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 14px; color: white; font-weight: 600; margin-top: 2px; }

        .ss-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 30px; }
        .ss-grid img { width: 100%; height: auto; max-height: 250px; object-fit: contain; border-radius: 8px; cursor: pointer; background: #000; border: 1px solid #333; }
        .btn-download { background: var(--gradient); color: white; padding: 15px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 16px; display: block; text-align: center; margin-top: 20px; }
        
        /* --- REVIEWS CSS (APKPure Style) --- */
        .reviews-section { margin-top: 30px; }
        .review-form textarea { width: 100%; background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; resize: none; }
        .btn-submit { background: #333; color: white; border: none; padding: 8px 25px; cursor: pointer; border-radius: 20px; font-weight: 600; font-size: 13px; }
        .btn-submit:hover { background: var(--primary); color: black; }
        
        /* THE REVIEW CARD */
        .review-item { 
            display: flex; gap: 15px; 
            padding: 20px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            position: relative;
        }
        
        /* Avatar */
        .review-avatar {
            width: 40px; height: 40px; border-radius: 50%; 
            background: var(--gradient); display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px; color: white; flex-shrink: 0;
            overflow: hidden;
        }
        .review-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* Content */
        .review-content-box { flex: 1; }
        .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .review-name { font-weight: 600; color: white; font-size: 14px; }
        .review-date { font-size: 11px; color: #888; margin-left: 10px; font-weight: normal; }
        .review-text { color: #ccc; font-size: 14px; line-height: 1.5; white-space: pre-wrap; }

        /* THREE DOTS MENU (Top Right) */
        .review-menu-container { position: relative; }
        .review-dots { 
            color: #888; cursor: pointer; font-size: 16px; padding: 5px; 
            transition: 0.2s;
        }
        .review-dots:hover { color: white; }
        
        /* Dropdown */
        .review-dropdown { 
            display: none; position: absolute; right: 0; top: 25px; 
            background: #252830; border: 1px solid #444; border-radius: 8px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 100; width: 130px;
            overflow: hidden;
        }
        .review-dropdown.show { display: block; }
        .review-dropdown div { padding: 10px 15px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #ccc; transition: 0.2s; }
        .review-dropdown div:hover { background: #333; color: white; }
        .review-dropdown div.delete-opt { color: var(--danger); border-top: 1px solid #333; }
        .review-dropdown div.delete-opt:hover { background: rgba(255, 71, 87, 0.1); }

        /* Toast */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; right: 30px; bottom: 30px; border-left: 5px solid var(--primary); transform: translateY(100px); transition: transform 0.3s; }
        #toast.show { visibility: visible; transform: translateY(0); }

        @media(max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } .nav-right { gap: 10px; } .search-bar input { width: 150px; } .hero-banner { height: 200px; } .hero-text h1 { font-size: 2rem; } }
    </style>
</head>
<body>

    <div id="toast">Notification</div>

    <!-- NAVBAR -->
    <nav>
        <div class="logo"><i class="fas fa-gamepad"></i> NEXUS</div>
        <div class="nav-right">
            <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Search..." onkeyup="filterGames()"></div>
            <button id="nav-login-btn" class="btn-login" onclick="showAuthModal('login')">Log In</button>
            <div id="nav-profile-btn" class="user-profile-icon" onclick="toggleSidebarView('profile')">U</div>
        </div>
    </nav>

    <!-- LAYOUT -->
    <div class="app-layout">
        <div class="sidebar">
            <div class="menu-item active" onclick="setView('home', this)"><i class="fas fa-home"></i> Home</div>
            <div class="menu-item" onclick="setView('wishlist', this)"><i class="fas fa-heart"></i> My Wishlist</div>
            <div class="menu-item" onclick="setView('history', this)"><i class="fas fa-history"></i> History</div>
            <div class="menu-item" onclick="setView('profile', this)"><i class="fas fa-user"></i> My Profile</div>
            <div style="flex:1"></div>
            <div id="sidebar-logout" class="menu-item" style="color:var(--danger); display:none;" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>

        <div class="main-content">
            <div id="view-home">
                <div class="hero-banner"><div class="hero-text"><h1>NEXT LEVEL<br>GAMING</h1><p>Explore unlimited apps & games.</p></div></div>
                <div style="margin-bottom:20px; font-size:20px; font-weight:600; display:flex; align-items:center; gap:10px;"><i class="fas fa-fire" style="color:var(--danger)"></i> Trending Now</div>
                <div id="loading" style="text-align:center; margin-top:50px;"><i class="fas fa-spinner fa-spin" style="font-size:30px; color:var(--primary)"></i></div>
                <div id="game-grid" class="grid"></div>
            </div>
            <div id="view-wishlist" style="display:none;"><h2>My Wishlist</h2><div id="wishlist-grid" class="grid"></div><div id="wishlist-empty" style="text-align:center; margin-top:50px; color:#666;">Empty list.</div></div>
            <div id="view-history" style="display:none;"><h2>Download History</h2><div id="history-grid" class="grid"></div></div>
            <div id="view-profile" style="display:none;">
                <div style="text-align:center; padding-top:50px;">
                    <div class="user-profile-icon" id="profile-pic-container" style="width:100px; height:100px; margin:0 auto; font-size:40px; display:flex;">U</div>
                    <h2 id="profile-name-large">User</h2>
                    <p id="profile-email-large" style="color:#888;">user@email.com</p>
                    <button class="btn-login" style="margin-top:15px; border-color:#444; color:white;" onclick="openEditProfileModal()"><i class="fas fa-edit"></i> Edit Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="authModal" class="auth-modal">
        <div class="auth-box">
            <button class="close-btn" onclick="closeAuthModal()" style="top:10px; right:10px;">&times;</button>
            <div id="login-form">
                <h2>Sign In</h2>
                <input type="email" id="login-email" class="auth-input" placeholder="Email">
                <input type="password" id="login-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="loginUser()">Login</button>
                <div class="toggle-auth" onclick="toggleAuthForm('signup')">New here? <span>Sign Up</span></div>
            </div>
            <div id="signup-form" style="display:none;">
                <h2>Create Account</h2>
                <input type="text" id="signup-name" class="auth-input" placeholder="Name">
                <input type="email" id="signup-email" class="auth-input" placeholder="Email">
                <input type="password" id="signup-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="signupUser()">Sign Up</button>
                <div class="toggle-auth" onclick="toggleAuthForm('login')">Have account? <span>Login</span></div>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="auth-modal">
        <div class="auth-box">
            <button class="close-btn" onclick="closeEditProfileModal()" style="top:10px; right:10px;">&times;</button>
            <h2>Edit Profile</h2>
            <div style="margin-bottom:15px;">
                <label for="edit-profile-file" style="cursor:pointer; display:inline-block;">
                    <div style="width:80px; height:80px; border-radius:50%; background:#222; margin:0 auto; display:flex; align-items:center; justify-content:center; border:1px dashed #666;">
                        <i class="fas fa-camera"></i>
                    </div>
                    <span style="font-size:12px; color:#888;">Change Photo</span>
                </label>
                <input type="file" id="edit-profile-file" hidden accept="image/*">
            </div>
            <input type="text" id="edit-profile-name" class="auth-input" placeholder="Display Name">
            <button class="auth-btn" onclick="saveProfileChanges()">Save</button>
        </div>
    </div>

    <!-- GAME MODAL -->
    <div id="gameModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <img id="m-cover" class="modal-header-img" src="">
            <div class="modal-body">
                <div class="game-head-row">
                    <img id="m-logo" class="game-logo-large" src="">
                    <div style="width:100%">
                        <h2 id="m-title" style="margin:0; font-size:2rem;">Title</h2>
                        <div class="verified-badge"><i class="fas fa-check-circle"></i> Official</div>
                    </div>
                </div>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">Downloads</span><span class="stat-value" id="m-downloads">0</span></div>
                    <div class="stat-item"><span class="stat-label">Updated</span><span class="stat-value" id="m-updated">Jan 01</span></div>
                </div>
                <div id="m-desc" class="game-desc"></div>
                <div class="gallery-title">Gallery</div>
                <div id="m-screenshots" class="ss-grid"></div>
                <a id="m-download" href="#" target="_blank" class="btn-download" onclick="handleDownload()">INSTALL NOW</a>
                
                <!-- REVIEWS -->
                <div class="reviews-section">
                    <div class="gallery-title">User Reviews</div>
                    <div class="review-form" id="review-form-container">
                        <textarea id="reviewText" rows="2" placeholder="Write a review..."></textarea>
                        <div style="display:flex; gap:10px;">
                            <button id="btn-post-review" class="btn-submit" onclick="submitReview()">Post</button>
                            <button id="btn-cancel-edit" class="btn-submit" style="background:#444; display:none;" onclick="cancelEditReview()">Cancel</button>
                        </div>
                    </div>
                    <div id="review-login-msg" style="display:none; color:#888; margin-bottom:15px; font-size:13px;">Please <span style="color:var(--primary); cursor:pointer;" onclick="showAuthModal('login')">Login</span> to review.</div>
                    <div id="reviews-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, runTransaction, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn1FBaxDwbvC28VWXAcq557uCidl-JHy0",
            authDomain: "app-store-6b5d4.firebaseapp.com",
            databaseURL: "https://app-store-6b5d4-default-rtdb.firebaseio.com",
            projectId: "app-store-6b5d4",
            storageBucket: "app-store-6b5d4.firebasestorage.app",
            messagingSenderId: "55022892860",
            appId: "1:55022892860:web:f48865da1539854bf8d039"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let allGames=[], currentUser=null, userWishlist={}, userDownloads={}, currentGameId=null, editingReviewId=null;

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if(user) {
                document.getElementById('nav-login-btn').style.display='none'; document.getElementById('nav-profile-btn').style.display='flex'; document.getElementById('sidebar-logout').style.display='flex';
                updateProfileDisplay(user); fetchUserData(user.uid);
            } else {
                document.getElementById('nav-login-btn').style.display='block'; document.getElementById('nav-profile-btn').style.display='none'; document.getElementById('sidebar-logout').style.display='none';
                userWishlist={}; userDownloads={}; renderGames(allGames);
            }
            updateReviewUI();
        });

        function updateProfileDisplay(user) {
            const html = user.photoURL ? `<img src="${user.photoURL}">` : (user.displayName?user.displayName.charAt(0).toUpperCase():"U");
            document.getElementById('nav-profile-btn').innerHTML = html; document.getElementById('profile-pic-container').innerHTML = html;
            document.getElementById('profile-name-large').innerText = user.displayName||"User"; document.getElementById('profile-email-large').innerText = user.email;
        }

        async function fetchUserData(uid) {
            onValue(ref(db, `users/${uid}/wishlist`), (s) => { userWishlist=s.val()||{}; renderGames(allGames); renderWishlist(); });
            onValue(ref(db, `users/${uid}/history`), (s) => { userDownloads=s.val()||{}; renderHistory(); });
        }

        window.loginUser = () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value).then(()=>{closeAuthModal();showToast("Success","success");}).catch(e=>alert(e.message));
        window.signupUser = () => {
            const name=document.getElementById('signup-name').value;
            createUserWithEmailAndPassword(auth, document.getElementById('signup-email').value, document.getElementById('signup-pass').value).then((c)=>{
                updateProfile(c.user,{displayName:name}).then(()=>{ update(ref(db,`users/${c.user.uid}`),{name:name,email:c.user.email}); closeAuthModal(); showToast("Account created","success"); updateProfileDisplay(c.user); });
            }).catch(e=>alert(e.message));
        };
        window.logoutUser = () => signOut(auth).then(()=>{showToast("Logged out","success"); setView('home');});

        // --- MAIN LOGIC ---
        onValue(ref(db, 'games'), (snapshot) => {
            document.getElementById('loading').style.display='none'; const data=snapshot.val();
            if(data) { allGames=Object.entries(data).map(([k,v])=>({...v,id:k})).reverse(); renderGames(allGames); renderWishlist(); renderHistory(); 
            if(currentGameId) { const g=allGames.find(x=>x.id===currentGameId); if(g)updateReviewsList(g.reviews); } }
        });

        window.renderGames = (games) => { const g=document.getElementById('game-grid'); g.innerHTML=""; games.forEach(game=>g.appendChild(createCard(game))); };
        window.renderWishlist = () => { const g=document.getElementById('wishlist-grid'); g.innerHTML=""; const w=allGames.filter(x=>userWishlist[x.id]); if(w.length===0)document.getElementById('wishlist-empty').style.display='block'; else{document.getElementById('wishlist-empty').style.display='none'; w.forEach(x=>g.appendChild(createCard(x)));} };
        window.renderHistory = () => { const g=document.getElementById('history-grid'); g.innerHTML=""; const h=allGames.filter(x=>userDownloads[x.id]); if(h.length===0)g.innerHTML="<div style='color:#666;width:100%;text-align:center'>No history</div>"; else h.forEach(x=>g.appendChild(createCard(x))); };

        function createCard(game) {
            const div=document.createElement('div'); div.className='card';
            const img=game.logo||"https://via.placeholder.com/300"; const liked=userWishlist[game.id]?'active':'';
            div.innerHTML=`<button class="wishlist-btn ${liked}" onclick="event.stopPropagation();toggleWishlist('${game.id}')"><i class="fas fa-heart"></i></button><div class="card-img-wrapper"><img src="${img}" onerror="this.src='https://via.placeholder.com/300'"></div><div class="card-content"><h3>${game.name}</h3><div class="card-stats"><span>${game.downloadCount||0} Downloads</span><span class="verified-badge">FREE</span></div></div>`;
            div.onclick=()=>openModal(game); return div;
        }

        window.toggleWishlist = (id) => { if(!currentUser)return showAuthModal('login'); const u={}; u[`users/${currentUser.uid}/wishlist/${id}`]=userWishlist[id]?null:true; update(ref(db),u); };

        // --- REVIEWS ---
        window.openModal = (game) => {
            currentGameId=game.id;
            document.getElementById('m-title').innerText=game.name; document.getElementById('m-desc').innerText=game.desc;
            document.getElementById('m-logo').src=game.logo; document.getElementById('m-download').href=game.download;
            document.getElementById('m-downloads').innerText=game.downloadCount||0; document.getElementById('m-updated').innerText=new Date(game.timestamp||Date.now()).toLocaleDateString();
            
            const gal=document.getElementById('m-screenshots'); gal.innerHTML="";
            const add=(s)=>{if(!s)return; let i=document.createElement('img'); i.src=s; i.onerror=function(){this.style.display='none'}; gal.appendChild(i);};
            if(game.screenshots&&Array.isArray(game.screenshots)) game.screenshots.forEach(add); else { if(game.sc1)add(game.sc1); if(game.sc2)add(game.sc2); if(game.sc3)add(game.sc3); if(game.sc4)add(game.sc4); }
            const f=gal.querySelector('img'); document.getElementById('m-cover').src=f?f.src:game.logo;

            updateReviewsList(game.reviews);
            document.getElementById('gameModal').classList.add('active'); document.body.style.overflow='hidden';
            cancelEditReview();
        };

        function updateReviewsList(reviews) {
            const list=document.getElementById('reviews-list'); list.innerHTML="";
            if(reviews) {
                Object.entries(reviews).reverse().forEach(([key, r]) => {
                    const isMine = currentUser && r.uid === currentUser.uid;
                    const date = new Date(r.date).toLocaleDateString();
                    // Avatar Logic
                    let avatarHtml = `<div class="review-avatar">${r.name.charAt(0).toUpperCase()}</div>`;
                    // If user has saved photo URL in review (optional enhancement later), else default initial
                    
                    let menu = "";
                    if(isMine) {
                        // Safe text escape
                        const safeText = r.text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                        menu = `
                            <div class="review-menu-container">
                                <i class="fas fa-ellipsis-v review-dots" onclick="toggleReviewMenu('${key}')"></i>
                                <div id="menu-${key}" class="review-dropdown">
                                    <div onclick="editReview('${key}', '${safeText}')"><i class="fas fa-edit"></i> Edit</div>
                                    <div onclick="deleteReview('${key}')" class="delete-opt"><i class="fas fa-trash"></i> Delete</div>
                                </div>
                            </div>
                        `;
                    }

                    list.innerHTML += `
                        <div class="review-item">
                            ${avatarHtml}
                            <div class="review-content-box">
                                <div class="review-header">
                                    <div><span class="review-name">${r.name}</span><span class="review-date">${date}</span></div>
                                    ${menu}
                                </div>
                                <div class="review-text">${r.text}</div>
                            </div>
                        </div>
                    `;
                });
            } else { list.innerHTML="<div style='color:#666;text-align:center;padding:20px;'>No reviews yet.</div>"; }
        }

        window.toggleReviewMenu = (key) => {
            const m=document.getElementById(`menu-${key}`);
            document.querySelectorAll('.review-dropdown').forEach(d=>{if(d!==m)d.classList.remove('show')});
            m.classList.toggle('show');
        };
        window.onclick = (e) => {
            if(!e.target.matches('.review-dots')) document.querySelectorAll('.review-dropdown').forEach(d=>d.classList.remove('show'));
            if(e.target.id=='gameModal')closeModal(); if(e.target.id=='authModal')closeAuthModal();
        }

        window.deleteReview = (key) => { if(confirm("Delete?")) remove(ref(db, `games/${currentGameId}/reviews/${key}`)); };
        
        window.editReview = (key, text) => {
            editingReviewId = key;
            document.getElementById('reviewText').value = text;
            document.getElementById('btn-post-review').innerText = "Update";
            document.getElementById('btn-cancel-edit').style.display = "inline-block";
            document.getElementById('reviewText').focus();
        };

        window.cancelEditReview = () => {
            editingReviewId = null;
            document.getElementById('reviewText').value = "";
            document.getElementById('btn-post-review').innerText = "Post";
            document.getElementById('btn-cancel-edit').style.display = "none";
        };

        window.submitReview = () => {
            if(!currentGameId || !currentUser) return;
            const txt = document.getElementById('reviewText').value; if(!txt)return;
            
            if(editingReviewId) {
                update(ref(db, `games/${currentGameId}/reviews/${editingReviewId}`), { text: txt, date: Date.now() })
                .then(() => { cancelEditReview(); showToast("Updated","success"); });
            } else {
                push(ref(db, `games/${currentGameId}/reviews`), {
                    name: currentUser.displayName||"User", uid: currentUser.uid, text: txt, date: Date.now()
                }).then(() => { document.getElementById('reviewText').value=""; showToast("Posted","success"); });
            }
        };

        function updateReviewUI() {
            document.getElementById('review-form-container').style.display=currentUser?'block':'none';
            document.getElementById('review-login-msg').style.display=currentUser?'none':'block';
        }

        // --- PROFILE/UTILS ---
        window.openEditProfileModal=()=>{if(!currentUser)return;document.getElementById('edit-profile-name').value=currentUser.displayName;document.getElementById('editProfileModal').style.display='flex';};
        window.closeEditProfileModal=()=>document.getElementById('editProfileModal').style.display='none';
        window.saveProfileChanges=async()=>{
            const n=document.getElementById('edit-profile-name').value; const f=document.getElementById('edit-profile-file');
            let p=currentUser.photoURL; if(f.files.length>0)p=await compressImage(f.files[0]);
            updateProfile(currentUser,{displayName:n,photoURL:p}).then(()=>{update(ref(db,`users/${currentUser.uid}`),{name:n,photoURL:p}); showToast("Saved","success"); updateProfileDisplay(currentUser); closeEditProfileModal();});
        };
        function compressImage(f){return new Promise(r=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas'),s=300/i.width;c.width=300;c.height=i.height*s;c.getContext('2d').drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.7))}}})}

        window.handleDownload=()=>{if(!currentGameId)return;runTransaction(ref(db,`games/${currentGameId}/downloadCount`),c=>(c||0)+1);if(currentUser)update(ref(db,`users/${currentUser.uid}/history`),{[currentGameId]:true});};
        window.setView=(id,btn)=>{['home','wishlist','history','profile'].forEach(v=>document.getElementById('view-'+v).style.display='none');document.getElementById('view-'+id).style.display='block';if(btn){document.querySelectorAll('.sidebar .menu-item').forEach(e=>e.classList.remove('active'));btn.classList.add('active');}};
        window.filterGames=()=>renderGames(allGames.filter(g=>g.name.toLowerCase().includes(document.getElementById('searchInput').value.toLowerCase())));
        window.showAuthModal=(t)=>{document.getElementById('authModal').style.display='flex';document.getElementById('login-form').style.display=t==='login'?'block':'none';document.getElementById('signup-form').style.display=t==='signup'?'block':'none';};
        window.closeAuthModal=()=>document.getElementById('authModal').style.display='none'; window.toggleAuthForm=(t)=>window.showAuthModal(t);
        window.closeModal=()=>{currentGameId=null;document.getElementById('gameModal').classList.remove('active');document.body.style.overflow='auto';};
        function showToast(m,t){const x=document.getElementById("toast");x.innerText=m;x.className="show "+t;setTimeout(()=>x.className="",3000);}
        window.toggleSidebarView=(v)=>setView(v,document.querySelectorAll('.menu-item')[3]);
    </script>
</body>
</html>