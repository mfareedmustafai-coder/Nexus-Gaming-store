<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Nexus Play Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #131313; --surface: #1e1e1e; --primary: #00A173; --text: #e3e3e3; --text-muted: #9aa0a6; --border: #303030; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 70px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* HEADER */
        header { position: fixed; top: 0; width: 100%; height: 60px; background: var(--bg); display: flex; align-items: center; padding: 0 15px; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.2); }
        .search-bar { flex: 1; background: var(--surface); height: 40px; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; margin-right: 15px; }
        .search-bar i { color: var(--text-muted); margin-right: 10px; }
        .search-bar input { background: transparent; border: none; color: white; width: 100%; font-size: 16px; }
        .profile-btn { width: 35px; height: 35px; border-radius: 50%; background: purple; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 18px; overflow: hidden; }
        .profile-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* TABS */
        .tabs { display: flex; gap: 10px; padding: 15px; overflow-x: auto; scrollbar-width: none; margin-top: 60px; }
        .tab { background: var(--surface); border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; white-space: nowrap; font-size: 14px; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .tab.active { background: #2f5346; color: #a8dbce; border-color: #2f5346; }

        /* APP LIST */
        .app-list { padding: 0 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .app-item { display: flex; flex-direction: column; cursor: pointer; align-items: flex-start; }
        .app-icon { width: 100%; aspect-ratio: 1; border-radius: 20px; object-fit: cover; background: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 8px; }
        .app-title { font-size: 12px; font-weight: 500; margin-bottom: 2px; color: #ddd; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .app-meta { font-size: 10px; color: var(--text-muted); display: flex; justify-content: space-between; width: 100%; }
        .price-badge { color: #81b7a7; font-weight: bold; }

        /* DETAIL VIEW */
        #app-detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding-bottom: 20px; }
        #app-detail-view.active { transform: translateY(0); }
        .detail-nav { padding: 15px; display: flex; justify-content: space-between; position: sticky; top: 0; background: var(--bg); z-index: 10; }
        
        .ps-header { padding: 0 20px; margin-bottom: 20px; }
        .ps-title-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .ps-icon { width: 80px; height: 80px; border-radius: 18px; object-fit: cover; background: #333; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .ps-info h1 { font-size: 24px; margin: 0; line-height: 1.2; font-weight: 500; }
        .ps-info p { color: var(--primary); font-size: 14px; font-weight: 500; margin: 5px 0 0 0; }
        
        .ps-stats-bar { display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; margin-bottom: 20px; overflow-x: auto; }
        .ps-stat-item { text-align: center; padding: 0 15px; border-right: 1px solid #333; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 80px; }
        .ps-stat-item:last-child { border: none; }
        .ps-stat-val { font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
        .ps-stat-label { font-size: 11px; color: #9aa0a6; }
        .age-box { border: 1px solid #fff; padding: 0 3px; font-size: 10px; border-radius: 2px; height: 16px; display: inline-flex; align-items: center; }

        /* INSTALL AREA */
        .install-area { padding: 0 20px; margin-bottom: 30px; }
        .btn-install { width: 100%; background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 25px; font-weight: 600; font-size: 16px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-install.downloading { background: #333; color: var(--text-muted); pointer-events: none; }
        .btn-buy { background: #00875f !important; color: white !important; box-shadow: 0 4px 10px rgba(0, 135, 95, 0.4); }
        
        .progress-wrapper { height: 4px; background: #333; margin-top: 15px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }

        .sc-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px; margin-bottom: 20px; scrollbar-width: none; }
        .sc-img { height: 200px; border-radius: 12px; object-fit: cover; background: #222; }
        .desc-box { padding: 0 20px; font-size: 14px; color: #ccc; line-height: 1.5; margin-bottom: 40px; }

        /* REVIEWS */
        .reviews-container { padding: 0 20px; margin-bottom: 50px; }
        .review-input-box { background: #2a2d36; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none; }
        .review-input-box textarea { width: 100%; background: transparent; border: none; color: white; font-size: 14px; resize: none; min-height: 60px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .btn-post { background: var(--primary); color: black; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 12px; float: right; cursor: pointer; }
        .review-card { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .r-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .r-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color:black; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:12px; }
        .r-name { font-size: 13px; font-weight: bold; }
        .r-date { font-size: 11px; color: #888; margin-left: auto; }
        .r-body { font-size: 13px; color: #ddd; line-height: 1.4; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-muted); cursor: pointer; gap: 4px; }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--primary); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .auth-box { background: var(--surface); padding: 30px; border-radius: 15px; width: 320px; text-align: center; border: 1px solid var(--border); }
        .auth-input { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); color: white; margin-bottom: 10px; border-radius: 5px; }
        .btn-auth { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 5px; font-weight: bold; color: #000; cursor: pointer; }
        .toggle-link { font-size: 12px; color: #aaa; margin-top: 15px; cursor: pointer; }
        .toggle-link span { color: var(--primary); font-weight: bold; }

        /* PAYMENT SPECIFIC */
        .pay-options { display: flex; gap: 10px; margin-bottom: 20px; }
        .pay-opt { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 13px; color: #aaa; background: #252830; }
        .pay-opt.active { border-color: var(--primary); color: white; background: #2f5346; }
        .pay-details-box { text-align: left; margin-bottom: 15px; }
        .pay-label { font-size: 12px; color: #888; margin-bottom: 5px; display: block; }
        .loader { display: inline-block; width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* PROFILE VIEW */
        #view-profile { display: none; padding: 30px 20px; text-align: center; margin-top: 60px; }
        .profile-pic-lg { width: 120px; height: 120px; border-radius: 50%; background: #333; margin: 0 auto; object-fit: cover; border: 3px solid var(--primary); position: relative; }
        .cam-icon { position: absolute; bottom: 0; right: 0; background: #00A173; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }
        .btn-full { width: 100%; padding: 14px; background: #2a2d36; color: white; border: 1px solid #444; border-radius: 10px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .btn-logout { background: #ff4757; color: white; border: none; }
    </style>
</head>
<body>

    <header>
        <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="search" placeholder="Search apps & games" onkeyup="window.filterApps()"></div>
        <div class="profile-btn" id="nav-profile" onclick="window.checkProfile()"><i class="fas fa-user"></i></div>
    </header>

    <div id="main-content-view">
        <div class="tabs">
            <div class="tab active" onclick="window.setCategory('All', this)">For you</div>
            <div class="tab" onclick="window.setCategory('Top Charts', this)">Top Charts</div>
            <div class="tab" onclick="window.setCategory('Action', this)">Action</div>
            <div class="tab" onclick="window.setCategory('Racing', this)">Racing</div>
            <div class="tab" onclick="window.setCategory('Tools', this)">Tools</div>
        </div>
        <div id="app-container" class="app-list" style="margin-top: 20px;">
            <div style="text-align:center; margin-top:50px; color:#666;">Loading Store...</div>
        </div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile">
        <div style="position: relative; width: 120px; margin: 0 auto;">
            <img id="p-img" src="https://via.placeholder.com/150" class="profile-pic-lg">
            <div class="cam-icon" onclick="document.getElementById('edit-file').click()"><i class="fas fa-camera"></i></div>
            <input type="file" id="edit-file" hidden accept="image/*">
        </div>
        <h2 class="p-name" id="p-name">Guest User</h2>
        <p class="p-email" id="p-email">Not Logged In</p>
        <div id="profile-actions" style="display:none;">
            <button class="btn-full" onclick="window.openEditProfileModal()">Edit Profile</button>
            <button class="btn-full btn-logout" onclick="window.logout()">Logout</button>
        </div>
        <div id="auth-actions">
            <button class="btn-full" style="background:var(--primary); color:black;" onclick="window.showAuthModal('login')">Login</button>
            <button class="btn-full" onclick="window.showAuthModal('signup')">Create Account</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="window.switchTab('home', this)"><i class="fas fa-gamepad"></i>Games</div>
        <div class="nav-item" onclick="window.switchTab('apps', this)"><i class="fas fa-layer-group"></i>Apps</div>
        <div class="nav-item" onclick="window.switchTab('search', this)"><i class="fas fa-search"></i>Search</div>
        <div class="nav-item" onclick="window.switchTab('profile', this)"><i class="fas fa-user"></i>Profile</div>
    </div>

    <!-- DETAIL VIEW -->
    <div id="app-detail-view">
        <div class="detail-nav"><i class="fas fa-arrow-left" style="font-size:20px; cursor:pointer;" onclick="window.closeDetail()"></i><i class="fas fa-search" style="font-size:20px;"></i></div>
        <div class="ps-header">
            <div class="ps-title-row">
                <img id="d-icon" class="ps-icon" src="">
                <div class="ps-info">
                    <h1 id="d-title">App Name</h1>
                    <p id="d-dev">Nexus Official</p>
                    <span style="font-size:12px; color:#aaa;">In-app purchases</span>
                </div>
            </div>
            <div class="ps-stats-bar">
                <div class="ps-stat-item"><div class="ps-stat-val">4.5 <i class="fas fa-star" style="font-size:10px"></i></div><div class="ps-stat-label">Reviews</div></div>
                <div class="ps-stat-item"><div class="ps-stat-val" id="d-size">MB</div><div class="ps-stat-label">Size</div></div>
                <div class="ps-stat-item"><div class="ps-stat-val"><div class="age-box" id="d-age">3+</div></div><div class="ps-stat-label">Rated</div></div>
                <div class="ps-stat-item"><div class="ps-stat-val" id="d-downloads">0</div><div class="ps-stat-label">Downloads</div></div>
            </div>
        </div>

        <div class="install-area">
            <button id="btn-install" class="btn-install" onclick="window.handleInstallClick()">Install</button>
            <div class="progress-wrapper" id="progress-wrap"><div class="progress-fill" id="progress-bar"></div></div>
        </div>

        <div class="sc-scroll" id="d-gallery"></div>
        <div class="desc-box"><h3 style="color:white; margin-bottom:10px;">About this app</h3><p id="d-desc"></p></div>

        <div class="reviews-container">
            <h3 style="color:white; margin-bottom:15px;">Ratings & Reviews</h3>
            <div id="review-input-box" class="review-input-box">
                <textarea id="review-text" placeholder="Describe your experience (optional)"></textarea>
                <div style="overflow:hidden;">
                    <button class="btn-post" id="r-post-btn" onclick="window.submitReview()">Post</button>
                    <button class="btn-post" id="r-cancel-btn" style="background:transparent; margin-right:10px; display:none;" onclick="window.cancelEditReview()">Cancel</button>
                </div>
            </div>
            <div id="review-login-prompt" style="text-align:center; padding:20px; color:#888; background:#191b21; border-radius:10px; margin-bottom:20px;">Please Sign In to review.</div>
            <div id="reviews-list"></div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="pay-modal" class="modal-overlay">
        <div class="auth-box">
            <h2 style="margin-top:0;">Payment Method</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:15px;">Amount: <span id="pay-amount" style="color:white; font-weight:bold;"></span></p>
            <div class="pay-options">
                <div class="pay-opt active" id="opt-bank" onclick="window.switchPay('bank')"><i class="fas fa-credit-card"></i> Bank</div>
                <div class="pay-opt" id="opt-ep" onclick="window.switchPay('ep')"><i class="fas fa-mobile-alt"></i> EasyPaisa</div>
            </div>
            <div id="form-bank" class="pay-details-box">
                <label class="pay-label">Card Number</label> <input class="auth-input" placeholder="0000 0000 0000 0000">
                <div style="display:flex; gap:10px;"><input class="auth-input" placeholder="MM/YY" style="flex:1"><input class="auth-input" placeholder="CVV" style="flex:1"></div>
            </div>
            <div id="form-ep" class="pay-details-box" style="display:none;">
                <label class="pay-label">Mobile Number</label> <input class="auth-input" placeholder="03XX-XXXXXXX">
            </div>
            <button class="btn-auth" id="pay-btn" onclick="window.processPayment()">Confirm Payment</button>
            <button onclick="document.getElementById('pay-modal').style.display='none'" style="background:none; border:none; color:#aaa; margin-top:10px;">Cancel</button>
        </div>
    </div>

    <!-- OPTIONS MODAL (NEW) -->
    <div id="options-modal" class="modal-overlay">
        <div class="auth-box">
            <h2 style="margin-top:0; color:#00A173;">Manage App</h2>
            <p style="color:#ccc; font-size:13px; margin-bottom:20px;">You already own this item.</p>
            
            <button class="btn-auth" style="background:#2f5346; color:#a8dbce; margin-bottom:10px;" onclick="window.startDownload()">Download (No Payment)</button>
            <button class="btn-auth" style="background:#ff4757; color:white;" onclick="window.returnPayment()">Return Payment</button>
            
            <button onclick="document.getElementById('options-modal').style.display='none'" style="background:none; border:none; color:#aaa; margin-top:15px;">Cancel</button>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="modal-overlay">
        <div class="auth-box">
            <h2 id="auth-title" style="margin-top:0">Sign In</h2>
            <input id="auth-name" type="text" class="auth-input" placeholder="Full Name" style="display:none;">
            <input id="auth-email" type="email" class="auth-input" placeholder="Email">
            <input id="auth-pass" type="password" class="auth-input" placeholder="Password">
            <button class="btn-auth" id="auth-action-btn" onclick="window.handleAuth()">Sign In</button>
            <p class="toggle-link" onclick="window.toggleAuthMode()">
                <span id="auth-toggle-text">Create account</span>
            </p>
            <button onclick="document.getElementById('auth-modal').style.display='none'" style="background:none; border:none; color:#aaa; margin-top:10px;">Cancel</button>
        </div>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="editModal" class="modal-overlay">
        <div class="auth-box">
            <h2 style="margin-top:0;">Edit Profile</h2>
            <input type="text" id="edit-name" class="auth-input" placeholder="Display Name">
            <button class="btn-auth" onclick="window.saveProfile()">SAVE CHANGES</button>
            <button onclick="window.closeEditModal()" style="background:none; border:none; color:#aaa; margin-top:10px;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, onValue, runTransaction, update, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCn1FBaxDwbvC28VWXAcq557uCidl-JHy0",
            authDomain: "app-store-6b5d4.firebaseapp.com",
            databaseURL: "https://app-store-6b5d4-default-rtdb.firebaseio.com",
            projectId: "app-store-6b5d4",
            storageBucket: "app-store-6b5d4.firebasestorage.app",
            messagingSenderId: "55022892860",
            appId: "1:55022892860:web:f48865da1539854bf8d039"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let allData = [], currentUser = null, userPurchases = {};
        let activeGame = null;
        let isSignupMode = false;
        let editReviewId = null;

        // AUTH & PURCHASES
        onAuthStateChanged(auth, u => {
            currentUser = u;
            const btn = document.getElementById('nav-profile');
            const reviewBox = document.getElementById('review-input-box');
            const reviewPrompt = document.getElementById('review-login-prompt');
            const profileActions = document.getElementById('profile-actions');
            const authActions = document.getElementById('auth-actions');

            if(u) {
                // LOGGED IN
                btn.style.background = "#00A173";
                btn.innerHTML = `<img src="${u.photoURL || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">`;
                
                document.getElementById('p-img').src = u.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('p-name').innerText = u.displayName || 'User';
                document.getElementById('p-email').innerText = u.email;
                profileActions.style.display = 'block';
                authActions.style.display = 'none';

                reviewBox.style.display = "block";
                reviewPrompt.style.display = "none";
                loadPurchases(u.uid);
            } else {
                // LOGGED OUT
                btn.style.background = "purple";
                btn.innerHTML = '<i class="fas fa-user"></i>';
                
                document.getElementById('p-img').src = 'https://via.placeholder.com/150';
                document.getElementById('p-name').innerText = 'Guest User';
                document.getElementById('p-email').innerText = 'Not Logged In';
                profileActions.style.display = 'none';
                authActions.style.display = 'block';

                userPurchases = {};
                reviewBox.style.display = "none";
                reviewPrompt.style.display = "block";
                
                if(activeGame) updateInstallButton(activeGame);
            }
        });

        function loadPurchases(uid) {
            onValue(ref(db, `users/${uid}/purchases`), s => {
                userPurchases = s.val() || {};
                if(activeGame) updateInstallButton(activeGame);
            });
        }

        // FETCH DATA
        onValue(ref(db, 'games'), (snap) => {
            const data = snap.val();
            if (data) {
                allData = Object.entries(data).map(([k, v]) => ({...v, id: k})).reverse();
                renderApps(allData);
                // REFRESH IF OPEN
                if(activeGame && document.getElementById('app-detail-view').classList.contains('active')) {
                     const updatedGame = allData.find(g => g.id === activeGame.id);
                     if(updatedGame) {
                         activeGame = updatedGame;
                         renderReviews(updatedGame.reviews); // Auto refresh comments
                     }
                }
            }
        });

        function renderApps(list) {
            const container = document.getElementById('app-container');
            container.innerHTML = "";
            list.forEach(game => {
                const isPaid = game.priceType === 'Paid';
                const priceText = isPaid ? game.price : "Free";
                const div = document.createElement('div');
                div.className = 'app-item';
                div.onclick = () => window.openDetail(game);
                div.innerHTML = `<img class="app-icon" src="${game.logo}" onerror="this.src='https://via.placeholder.com/60'"><div class="app-info"><div class="app-title">${game.name}</div><div class="app-meta"><span>${game.category}</span><span class="price-badge" style="color:#81b7a7; font-weight:bold;">${priceText}</span></div></div>`;
                container.appendChild(div);
            });
        }

        window.openDetail = (game) => {
            activeGame = game;
            document.getElementById('d-title').innerText = game.name;
            document.getElementById('d-desc').innerText = game.desc;
            document.getElementById('d-icon').src = game.logo;
            document.getElementById('d-dev').innerText = game.developer || "Nexus Official";
            document.getElementById('d-size').innerText = game.size || "Varies";
            document.getElementById('d-age').innerText = game.age || "3+";
            document.getElementById('d-downloads').innerText = (game.downloadCount || "0") + "+";

            const gal = document.getElementById('d-gallery');
            gal.innerHTML = "";
            let shots = game.screenshots || [];
            if(!Array.isArray(shots)) { shots = []; if(game.sc1) shots.push(game.sc1); }
            shots.forEach(s => { gal.innerHTML += `<img src="${s}" class="sc-img">`; });

            updateInstallButton(game);
            renderReviews(game.reviews);
            document.getElementById('app-detail-view').classList.add('active');
        };

        function updateInstallButton(game) {
            const btn = document.getElementById('btn-install');
            const isPaid = game.priceType === 'Paid';
            const isOwned = userPurchases[game.id];

            btn.classList.remove('downloading', 'btn-buy');
            btn.style.background = "var(--primary)";
            document.getElementById('progress-wrap').style.display = 'none';

            if (isPaid && !isOwned) {
                btn.innerText = `Buy for ${game.price}`;
                btn.classList.add('btn-buy'); 
                btn.style.background = "#00875f";
            } else {
                btn.innerText = "Install";
            }
        }

        window.closeDetail = () => document.getElementById('app-detail-view').classList.remove('active');

        // INSTALL / PAYMENT
        window.handleInstallClick = () => {
            if(!currentUser) { isSignupMode=false; updateAuthUI(); return document.getElementById('auth-modal').style.display='flex'; }
            
            const isPaid = activeGame.priceType === 'Paid';
            const isOwned = userPurchases[activeGame.id];

            if (isPaid && !isOwned) {
                document.getElementById('pay-amount').innerText = activeGame.price;
                document.getElementById('pay-modal').style.display = 'flex';
            } else {
                // If Free OR Owned -> Direct logic
                // NEW: If Owned (Paid), show options
                if (isPaid && isOwned) {
                    document.getElementById('options-modal').style.display = 'flex';
                } else {
                    window.startDownload(); // Free App logic
                }
            }
        };
        
        // Return Payment
        window.returnPayment = () => {
            if(confirm("Are you sure? You will lose access to this app and get a refund.")) {
                remove(ref(db, `users/${currentUser.uid}/purchases/${activeGame.id}`))
                .then(() => {
                    delete userPurchases[activeGame.id];
                    updateInstallButton(activeGame);
                    document.getElementById('options-modal').style.display = 'none';
                    alert("Payment Returned (App Removed)");
                });
            }
        };

        window.switchPay = (method) => {
            document.querySelectorAll('.pay-opt').forEach(e => e.classList.remove('active'));
            document.getElementById('opt-'+method).classList.add('active');
            document.getElementById('form-bank').style.display = method === 'bank' ? 'block' : 'none';
            document.getElementById('form-ep').style.display = method === 'ep' ? 'block' : 'none';
        };

        window.processPayment = () => {
            const btn = document.getElementById('pay-btn');
            btn.innerHTML = `<span class="loader"></span> Processing...`;
            setTimeout(() => {
                update(ref(db, `users/${currentUser.uid}/purchases`), { [activeGame.id]: true })
                .then(() => {
                    userPurchases[activeGame.id] = true;
                    updateInstallButton(activeGame); 
                    document.getElementById('pay-modal').style.display = 'none';
                    btn.innerText = "Confirm Payment"; 
                    window.startDownload();
                });
            }, 2500);
        };

        window.startDownload = () => {
            document.getElementById('options-modal').style.display = 'none';
            const link = activeGame.download;
            if(link) window.open(link, '_blank'); 

            const btn = document.getElementById('btn-install');
            const bar = document.getElementById('progress-bar');
            const wrap = document.getElementById('progress-wrap');

            btn.innerText = "Downloading...";
            btn.classList.add('downloading');
            wrap.style.display = 'block';
            
            let w = 0;
            const int = setInterval(() => {
                w += 15;
                if(w >= 100) {
                    w = 100;
                    clearInterval(int);
                    btn.innerText = "Open";
                    btn.classList.remove('downloading');
                    btn.style.background = "#2f5346"; 
                    wrap.style.display = 'none';
                    runTransaction(ref(db, `games/${activeGame.id}/downloadCount`), c => (c || 0) + 1);
                }
                bar.style.width = w + "%";
            }, 300);
        };

        // REVIEWS & AUTH (FIXED FUNCTION NAME)
        function renderReviews(reviews) {
            const list = document.getElementById('reviews-list');
            list.innerHTML = "";
            if(!reviews) { list.innerHTML = "<p style='color:#666; font-size:13px;'>No reviews yet.</p>"; return; }
            Object.entries(reviews).reverse().forEach(([key, r]) => {
                const isMine = currentUser && r.uid === currentUser.uid;
                const safeText = r.text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                let menu = "";
                if(isMine) {
                    menu = `<div style="margin-left:auto;"><i class="fas fa-edit r-menu-btn" style="color:#aaa; cursor:pointer; margin-right:10px;" onclick="window.editReview('${key}', '${safeText}')"></i><i class="fas fa-trash r-menu-btn" style="color:#ff4757; cursor:pointer;" onclick="window.deleteReview('${key}')"></i></div>`;
                }
                const photo = r.photoURL ? `<img src="${r.photoURL}">` : r.name.charAt(0).toUpperCase();
                list.innerHTML += `<div class="review-card"><div class="r-header"><div class="r-user"><div class="r-avatar">${photo}</div><div><div style="font-weight:700; font-size:14px; color:white;">${r.name}</div><div style="font-size:11px; color:#666;">${new Date(r.date).toLocaleDateString()}</div></div></div>${menu}</div><div class="r-text">${r.text}</div></div>`;
            });
        }
        
        // RENAMED postReview -> submitReview to match HTML
        window.submitReview = () => {
            if(!currentUser) return alert("Please Login first!");
            const txt = document.getElementById('review-text').value; if(!txt) return;
            const reviewData = { name: currentUser.displayName || "User", uid: currentUser.uid, text: txt, date: Date.now(), photoURL: currentUser.photoURL || null };
            
            if(editReviewId) {
                update(ref(db, `games/${activeGame.id}/reviews/${editReviewId}`), reviewData).then(() => window.cancelEditReview());
            } else {
                push(ref(db, `games/${activeGame.id}/reviews`), reviewData).then(() => document.getElementById('review-text').value = "");
            }
        };

        window.deleteReview = (k) => { if(confirm("Delete?")) remove(ref(db, `games/${activeGame.id}/reviews/${k}`)); };
        window.editReview = (k, txt) => { editReviewId = k; document.getElementById('review-text').value = txt; document.getElementById('r-post-btn').innerText = "Update"; document.getElementById('r-cancel-btn').style.display = "inline-block"; };
        window.cancelEditReview = () => { editReviewId = null; document.getElementById('review-text').value = ""; document.getElementById('r-post-btn').innerText = "Post"; document.getElementById('r-cancel-btn').style.display = "none"; };

        window.checkProfile = () => window.switchTab('profile', document.querySelectorAll('.nav-item')[3]);
        window.toggleAuthMode = () => { isSignupMode = !isSignupMode; updateAuthUI(); };
        function updateAuthUI() {
            const title = document.getElementById('auth-title');
            const nameInput = document.getElementById('auth-name');
            const btn = document.getElementById('auth-action-btn');
            const toggleText = document.getElementById('auth-toggle-text');
            if(isSignupMode) { title.innerText = "Create Account"; nameInput.style.display = "block"; btn.innerText = "Sign Up"; toggleText.innerText = "Sign In"; } 
            else { title.innerText = "Sign In"; nameInput.style.display = "none"; btn.innerText = "Sign In"; toggleText.innerText = "Create account"; }
        }
        window.handleAuth = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            const n = document.getElementById('auth-name').value;
            if(isSignupMode) {
                if(!n) return alert("Name required");
                createUserWithEmailAndPassword(auth, e, p).then((cred) => {
                    updateProfile(cred.user, {displayName: n}).then(() => document.getElementById('auth-modal').style.display = 'none');
                }).catch(err => alert(err.message));
            } else {
                signInWithEmailAndPassword(auth, e, p).then(() => document.getElementById('auth-modal').style.display = 'none').catch(err => alert(err.message));
            }
        };
        window.logout = () => signOut(auth);

        window.openEditProfileModal = () => document.getElementById('editModal').style.display = 'flex';
        window.closeEditModal = () => document.getElementById('editModal').style.display = 'none';
        window.saveProfile = async () => {
            const n = document.getElementById('edit-name').value;
            const f = document.getElementById('edit-file').files[0];
            let p = currentUser.photoURL;
            if(f) p = await compress(f);
            updateProfile(currentUser, {displayName: n, photoURL: p}).then(() => {
                window.closeEditModal(); alert("Profile Updated");
            });
        };
        const compress = (f) => new Promise(r => { const rd=new FileReader(); rd.readAsDataURL(f); rd.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'),s=300/i.width; c.width=300; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.7))}}});

        window.filterApps = () => { const q = document.getElementById('search').value.toLowerCase(); renderApps(allData.filter(g => g.name.toLowerCase().includes(q))); };
        window.setCategory = (cat, btn) => { document.querySelectorAll('.tab').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderApps(allData.filter(g => cat === 'All' || g.category === cat)); };
        window.setType = (type, btn) => { document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderApps(allData.filter(g => (g.type || 'Game') === type)); };
        
        window.switchTab = (tab, btn) => {
            document.getElementById('main-content-view').style.display = (tab === 'profile') ? 'none' : 'block';
            document.getElementById('view-profile').style.display = (tab === 'profile') ? 'block' : 'none';
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(tab === 'apps') window.setType('App', btn);
            if(tab === 'home') window.setType('Game', btn); 
        };
    </script>
</body>
</html>